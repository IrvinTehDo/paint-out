<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script type="text/babel" >
        "use strict";
    let canvas;
    let ctx;

    let socket;
    let hash;

    let moveDown = false;
    let moveUp = false;
    let moveRight = false;
    let moveLeft = false;
//    let canMove = false;

    let room = {};
    let timer;

const setUser = (data, lobby) => {
    hash = data.hash;
    room = lobby;
    console.dir(room);
    console.log(hash);
};

const update = (data) => {
        if(!room.players[data.hash]){
            room.players[data.hash] = data;
            return;
        }

    const player = room.players[data.hash];

    if(player.lastUpdate >= data.lastUpdate){
        return;
    }

    player.lastUpdate = data.lastUpdate;

    player.prevX = data.prevX;
    player.prevY = data.prevY;
    player.destX = data.destX;
    player.destY = data.destY;
    player.alpha = 0.05;
};


const errorEmitter = (error) => {
    const errorContiner = document.querySelector("#error");
    errorContiner.innerHTML = error;
};

const lerp = (v0, v1, alpha) => {
    return (1-alpha) * v0 + alpha * v1;
};

const updatePosition = () => {
    const player = room.players[hash];
    player.prevX = player.x;
    player.prevY = player.y;
    
    if(moveUp && player.destY > 0){
        player.destY -= 2;
    }
    
    if(moveDown && player.destY < 500){
        player.destY += 2;
    }
    
    if(moveLeft && player.destX > 0){
        player.destX -= 2;
    }
    
    if(moveRight && player.destX < 700){
        player.destX += 2;
    }
    
    player.alpha = 0.05;
};

const drawPlayer = () => {
    const keys = Object.keys(room.players);
    
    for(let i = 0; i< keys.length; i++){
        const player = room.players[keys[i]];
        
        if(player.alpha < 1){
            player.alpha += 0.05;
        }
        
        ctx.fillStyle = player.color;
        
        player.x = lerp(player.prevX, player.destX, player.alpha);
        player.y = lerp(player.prevY, player.destY, player.alpha);
        
        ctx.fillRect(player.x, player.y, player.width, player.height);
    }
}

const redraw = (time) => {
//    updatePosition();
//    updateMovement();
//    drawPlayer();
    
    if(room.status === 'waiting'){
        updateMovement();
        drawPlayer();
        requestAnimationFrame(redraw);
    } else if(room.status === 'playing' && room.time > 0){
        updatePosition();
        updateMovement();
        drawPlayer();
        requestAnimationFrame(redraw);
    }
};

const updateMovement = () => {
          socket.emit('movementUpdate', room.players[hash]);
};


const roomJoined = (reqRoom) => {
    const roomNameLabel = document.querySelector("#roomName");
    roomNameLabel.textContent = `Room: ${reqRoom.roomName}`;
    room = {};
    room = reqRoom;
    requestAnimationFrame(redraw);
    console.dir(room);
};

const updateTime = (time, status) => {
    room.time = time;
    room.status = status;
    timer.textContent = `Room Status: ${room.status} | Time: ${room.time}`;
};

const sendRedCanvas = () => {
    console.log('attempting to send');
    if(room.players[hash].color === 'red'){
        const canvasImg = ctx.getImageData(0,0,canvas.width, canvas.height);
        console.log(`${hash} sending image ${canvasImg}`);
        console.dir(canvasImg);
        console.dir(canvasImg.data.length);
        socket.emit('sendRedCanvas', canvasImg.data, room.roomName, canvasImg.data.length);
    }
};

const handleResults = (results) => {
    ctx.font = "30px Arial";
    ctx.fillStyle = "black";
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'center';
    ctx.fillText(results, canvas.width/2, canvas.height/2);
    console.log(results);
};

const joinRoom = (e, roomName, create) => {
    
    if(room.roomName != 'lobby') {
        e.preventDefault();
        return false;
    }
    
    if(create){
        socket.emit('createRoom', roomName);
    }
    
    else{
        socket.emit('joinRoom', roomName);
    }
    
    const errorContiner = document.querySelector("#error");
    
    errorContiner.innerHTML = "";
    
    e.preventDefault();
    return false;
};

const forceMoveToLobby = () => {
    socket.emit('moveToLobby', room.roomName);
    clearCanvas();
    timer.textContent = `Room Status: Lobby | Time: ???`
};


const keyDownHandler = (e) => {  
          var keyPressed = e.which;

          if(keyPressed === 87 || keyPressed === 38) {
            moveUp = true;
          }

          else if(keyPressed === 65 || keyPressed === 37) {
            moveLeft = true;
          }

          else if(keyPressed === 83 || keyPressed === 40) {
            moveDown = true;
          }

          else if(keyPressed === 68 || keyPressed === 39) {
            moveRight = true;
          }
    
          if(moveUp || moveDown || moveLeft || moveRight || keyPressed === 46) {
            e.preventDefault();
          }
        };

const keyUpHandler = (e) => {
          var keyPressed = e.which;

          if(keyPressed === 87 || keyPressed === 38) {
            moveUp = false;
          }

          else if(keyPressed === 65 || keyPressed === 37) {
            moveLeft = false;
          }

          else if(keyPressed === 83 || keyPressed === 40) {
            moveDown = false;
          }

          else if(keyPressed === 68 || keyPressed === 39) {
            moveRight = false;
          }
    
        };


const clearCanvas = (data) => {
    ctx.clearRect(0,0,600,800);
};
        
        const init = () => {
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");
            
            socket = io.connect();
            
            socket.on('joined', setUser);
            
            socket.on('roomError', errorEmitter);
            socket.on('forceMoveToLobby', forceMoveToLobby);
            socket.on('updateTime', updateTime);
            socket.on('roomJoined', roomJoined);
            socket.on('updatedMovement', update);
            socket.on('scoreGame', sendRedCanvas);
            socket.on('results', handleResults);
            
            const createRoomForm = document.querySelector('#createRoomForm');
            const sendCreateReq = (e) => joinRoom(e, createRoomForm.querySelector("#createRoomField").value, true);
            createRoomForm.addEventListener('submit', sendCreateReq);
            
            const joinRoomForm = document.querySelector('#joinRoomForm');
            const sendJoinReq = (e) => joinRoom(e, joinRoomForm.querySelector("#joinRoomField").value, false);
            joinRoomForm.addEventListener('submit', sendJoinReq);
            
            timer = document.querySelector('#timer');
            
            document.body.addEventListener('keydown', keyDownHandler);
            document.body.addEventListener('keyup', keyUpHandler);
        };
        
        window.onload = init;
    </script>
    <style>
        h1{
            margin: auto;
            text-align: center;
            width:50%;

        }
        
        #errorContainer{
            margin: auto;
            width:50%;
            text-align: center;
        }
        
        #roomContainer{
            margin: auto;
            width:50%;
            text-align: center;
        }
        
        #createRoomForm{
            
        }
        
        #joinRoomForm{
            
        }
        
        #canvasContainer{
            margin: auto;
            width:50%;
            text-align: center;
            
        }
        #canvas{
        }
        
        #roomName{
        }
        
        #timer{
        }
        

    </style>
</head>
<body>
    <div id="errorContainer">
        <section id="error"> </section>
    </div>
    
    <h1>Paint Out!</h1>
    
    <div id="roomContainer">
        <form id="createRoomForm">
            <label for="createRoom">Create a Room</label>
            <input id="createRoomField" type="text" name="createRoom" maxlength="4" size="4">
            <input type="submit" value="Create Room">
        </form>
        <form id="joinRoomForm">
            <label for="joinRoom">Join a Room</label>
            <input id="joinRoomField" type="text" name="joinRoom" maxlength="4" size ="4">
            <input type="submit" value="Join Room">
        </form>
    </div>
    
    
    <div id="canvasContainer">
        <h2 id="roomName">Room: lobby</h2>
        <canvas id="canvas" width="800" height="600" style="border:1px solid #000000;"></canvas>
        <h2 id="timer">Room Status: Lobby | Time: ???</h2>
    </div>
</body>
</html>